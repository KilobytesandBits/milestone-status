<!DOCTYPE html>
<html>
<head>
    <title>MilestoneStatusApp</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var types=Ext.data.Types;Ext.define("MilestoneTreeModel",{extend:"Ext.data.TreeModel",fields:[{name:"FormattedID",mapping:"FormattedID",type:types.STRING},{name:"Name",mapping:"Name",type:types.STRING},{name:"StartDate",mapping:"ActualStartDate",type:types.DATE},{name:"TargetDate",mapping:"AcceptedDate",type:types.DATE},{name:"TargetProject",mapping:"TargetProject",type:types.OBJECT},{name:"ValueStream",mapping:"ValueStream",type:types.STRING},{name:"Visibility",mapping:"Visibility",type:types.STRING},{name:"Status",mapping:"Status",type:types.STRING},{name:"DisplayColor",mapping:"DisplayColor",type:types.STRING},{name:"Notes",mapping:"Notes",type:types.STRING},{name:"_ref",mapping:"_ref",type:types.STRING},{name:"AcceptedLeafStoryCount",mapping:"AcceptedLeafStoryCount",type:types.STRING},{name:"LeafStoryCount",mapping:"LeafStoryCount",type:types.STRING},{name:"FeaturesWithoutChildrenCount",mapping:"FeaturesWithoutChildrenCount",type:types.INT},{name:"StoryProgressPercent",mapping:"StoryProgressPercent",type:types.FLOAT}],hasMany:{model:"FeatureTreeModel",name:"features",associationKey:"features"}}),Ext.define("MilestoneDataModel",{extend:"Ext.data.Model",fields:[{name:"FormattedID",mapping:"FormattedID",type:types.STRING},{name:"Name",mapping:"Name",type:types.STRING},{name:"StartDate",mapping:"ActualStartDate",type:types.DATE},{name:"TargetDate",mapping:"AcceptedDate",type:types.DATE},{name:"TargetProject",mapping:"TargetProject",type:types.OBJECT},{name:"ValueStream",mapping:"ValueStream",type:types.STRING},{name:"Visibility",mapping:"Visibility",type:types.STRING},{name:"Status",mapping:"Status",type:types.STRING},{name:"DisplayColor",mapping:"DisplayColor",type:types.STRING},{name:"Notes",mapping:"Notes",type:types.STRING},{name:"_ref",mapping:"_ref",type:types.STRING},{name:"AcceptedLeafStoryCount",mapping:"AcceptedLeafStoryCount",type:types.INT},{name:"LeafStoryCount",mapping:"LeafStoryCount",type:types.INT},{name:"FeaturesWithoutChildrenCount",mapping:"FeaturesWithoutChildrenCount",type:types.INT},{name:"StoryProgressPercent",mapping:"StoryProgressPercent",type:types.FLOAT}]}),Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"filterContainer",id:"filterContainer"},{xtype:"container",itemId:"gridContainer",id:"gridContainer"}],getSettingsFields:function(){return[{name:"includeGlobalMilestones",xtype:"rallycheckboxfield",fieldLabel:"",boxLabel:"Include global milestones"},{name:"showNumberOfMonths",xtype:"rallynumberfield",fieldLabel:"Date Range (months)"}]},launch:function(){this.down("#filterContainer").add({xtype:"rallycheckboxfield",id:"executiveVisibilityCheckbox",boxLabel:"Show Executive Visibility Only",labelWidth:200,padding:"10, 5, 10, 5",checked:!0,listeners:{change:this._onReady,render:this._onReady,scope:this}})},_onReady:function(){this._getAllChildProjectsForCurrentProject(this.project)},_getAllChildProjectsForCurrentProject:function(currProject){Ext.getBody().mask("Loading..."),this.allProjectsList=[];var that=this,projectStore=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name","State","Parent","Children"],autoLoad:!0,compact:!1,context:{workspace:that.getContext().getWorkspace()._Ref,projectScopeUp:!1,projectScopeDown:!0},limit:1/0,filters:[{property:"State",operator:"=",value:"Open"}],sorters:[{property:"Name",direction:"ASC"}],listeners:{load:function(projectStore,data,success){this.requiredProjectsList=[],this.allProjectsColl=data;var selectedProj=this.getContext().getProject(),selectedProjRef="/project/"+selectedProj.ObjectID;this.requiredProjectsList.push(selectedProj.ObjectID);var selectedProjChildren=selectedProj.Children;selectedProjChildren&&selectedProjChildren.Count>0&&this._loadAllChildProjectsFromParent(selectedProjRef),this._createMilestoneStoreFilter(),this._createMilestoneStore()},scope:this}})},_loadAllChildProjectsFromParent:function(parentProjRef){var that=this;Ext.Array.each(this.allProjectsColl,function(thisProject){if(thisProject.get("Parent")&&null!==thisProject.get("Parent")._ref&&thisProject.get("Parent")._ref==parentProjRef){that.requiredProjectsList.push(thisProject.data.ObjectID);var projChildren=thisProject.get("Children");projChildren&&projChildren.Count>0&&that._loadAllChildProjectsFromParent(thisProject.get("_ref"))}})},_createMilestoneStoreFilter:function(){if(this.projectMilestoneFilter=Ext.create("Rally.data.wsapi.Filter",{property:"TargetDate",operator:">=",value:"today-15"}),this._getVisibilityFilter()&&(this.projectMilestoneFilter=this.projectMilestoneFilter.and(Ext.create("Rally.data.wsapi.Filter",{property:"c_ExecutiveVisibility",operator:"=",value:this._getVisibilityFilter()}))),this.getSetting("showNumberOfMonths")&&this.getSetting("showNumberOfMonths")>0){var endDate=Rally.util.DateTime.add(new Date,"month",this.getSetting("showNumberOfMonths"));this.projectMilestoneFilter=this.projectMilestoneFilter.and(Ext.create("Rally.data.wsapi.Filter",{property:"TargetDate",operator:"<=",value:endDate}))}},_createMilestoneStore:function(){Ext.create("Rally.data.wsapi.Store",{model:"milestone",autoLoad:!0,compact:!1,listeners:{load:function(store,data,success){this._filterMileStones(data)},scope:this},filters:this.projectMilestoneFilter,sorters:[{property:"c_ValueStream",direction:"ASC"},{property:"TargetDate",direction:"ASC"}]})},_filterMileStones:function(milestones){var that=this,filteredMilestonesArr=[];Ext.each(milestones,function(milestone,index){null!==milestone.data.TargetProject&&""!==milestone.data.TargetProject&&that.requiredProjectsList.indexOf(milestone.data.TargetProject.ObjectID)>-1&&filteredMilestonesArr.push(milestone),that.getSetting("includeGlobalMilestones")&&null===milestone.data.TargetProject&&filteredMilestonesArr.push(milestone)}),this._loadArtifactsForMilestones(filteredMilestonesArr)},_loadArtifactsForMilestones:function(milestoneArr){var that=this;this._loadArtifacts(milestoneArr).then({success:function(records){that.milestoneDataArray=[],Ext.Array.each(records,function(record,index){var storyCountInfo=that._computeArtifactsAssociation(record),milestoneRec=milestoneArr[index],milestoneCustomData=that._createCustomMilestoneData(milestoneRec,storyCountInfo);that.milestoneDataArray.push(milestoneCustomData)}),that._organiseMilestoneBasedOnValuestream(that.milestoneDataArray)},failure:function(error){console.log("There are some errors"),Ext.getBody().unmask()},scope:that})},_createCustomMilestoneData:function(milestoneItem,storyCountInfo){var milestoneData=Ext.create("MilestoneDataModel",{FormattedID:milestoneItem.get("FormattedID"),Name:milestoneItem.get("Name"),StartDate:storyCountInfo.startDate,TargetDate:milestoneItem.get("TargetDate"),TargetProject:milestoneItem.get("Name"),ValueStream:milestoneItem.get("c_ValueStream"),Visibility:milestoneItem.get("c_ExecutiveVisibility"),Status:milestoneItem.get("c_Test"),DisplayColor:milestoneItem.get("DisplayColor"),Notes:milestoneItem.get("Notes"),_ref:milestoneItem.get("_ref"),AcceptedLeafStoryCount:storyCountInfo.acceptedCount,LeafStoryCount:storyCountInfo.storyCount,FeaturesWithoutChildrenCount:storyCountInfo.featureNotBrokenCount,StoryProgressPercent:storyCountInfo.storyCount>0?storyCountInfo.acceptedCount/storyCountInfo.storyCount:0});return milestoneData},_loadArtifacts:function(milestoneList){var promises=[],that=this;return Ext.Array.each(milestoneList,function(milestone){var artifactStore=Ext.create("Rally.data.wsapi.artifact.Store",{models:["portfolioitem/feature","defect","userstory"],context:{workspace:that.getContext().getWorkspace()._Ref,project:null,limit:1/0,projectScopeUp:!1,projectScopeDown:!0},filters:[{property:"Milestones.ObjectID",operator:"=",value:milestone.get("ObjectID")}]});promises.push(that._loadArtifactStore(artifactStore))}),Deft.Promise.all(promises)},_loadArtifactStore:function(store){var deferred;return deferred=Ext.create("Deft.Deferred"),store.load({callback:function(records,operation,success){success?deferred.resolve(records):deferred.reject("Error loading Companies.")}}),deferred.promise},_computeArtifactsAssociation:function(artifactColl){var storyCountInfo={storyCount:0,acceptedCount:0,startDate:null,featureNotBrokenCount:0},leafStoryCount=0,acceptedLeafStoryCount=0,startDate=null,featuresWithoutChildren=0;return artifactColl.length>0&&Ext.Array.each(artifactColl,function(item){var itemType=item.get("_type"),scheduleState=item.get("ScheduleState");if("hierarchicalrequirement"==itemType||"defect"==itemType){leafStoryCount+=1,"Accepted"==scheduleState&&(acceptedLeafStoryCount+=1);var inProgressDate=item.get("InProgressDate");(null===startDate||startDate>inProgressDate)&&(startDate=inProgressDate)}else{0===item.get("LeafStoryCount")?featuresWithoutChildren+=1:(leafStoryCount+=item.get("LeafStoryCount"),acceptedLeafStoryCount+=item.get("AcceptedLeafStoryCount"));var portfolioStartDate=item.get("ActualStartDate");(null===startDate||startDate>portfolioStartDate)&&(startDate=portfolioStartDate)}}),storyCountInfo.storyCount=leafStoryCount,storyCountInfo.acceptedCount=acceptedLeafStoryCount,storyCountInfo.featureNotBrokenCount=featuresWithoutChildren,null!==startDate&&(storyCountInfo.startDate=startDate),storyCountInfo},_organiseMilestoneBasedOnValuestream:function(filteredMilestonesArr){this.valueStreamMilestoneColl=[],this.valueStreamColl=[];var nonVSCount=0,that=this;Ext.Array.each(filteredMilestonesArr,function(thisData){var valuestream=thisData.get("ValueStream");null!==valuestream&&""!==valuestream?0===that.valueStreamColl.length?that.valueStreamColl.push(valuestream):that.valueStreamColl.length>0&&-1===that.valueStreamColl.indexOf(valuestream)&&that.valueStreamColl.push(valuestream):nonVSCount++}),this.valueStreamColl.sort(),nonVSCount>0&&this.valueStreamColl.push("N/A"),Ext.Array.each(this.valueStreamColl,function(valuestream){var milestoneColl=that._getAllAssociatedMilestones(valuestream,filteredMilestonesArr);that.valueStreamMilestoneColl.push({key:valuestream,value:milestoneColl})}),this._createValueStreamMilestonesTreeNode()},_createValueStreamMilestonesTreeNode:function(){var valueStreamRootNode=Ext.create("MilestoneTreeModel",{Name:"ValueStream Root",text:"ValueStream Root",root:!0,expandable:!0,expanded:!0});this._createValueStreamNodesAlongWithAssociatedChildMilestoneNodes(valueStreamRootNode),this._createValueStreamMilestoneGrid(valueStreamRootNode)},_createValueStreamMilestoneGrid:function(valueStreamRootNode){var milestonesTreePanel=Ext.getCmp("milestonesTreePanel");milestonesTreePanel&&milestonesTreePanel.destroy();var me=this,milestoneValueStreamTreeStore=Ext.create("Ext.data.TreeStore",{model:"MilestoneTreeModel",root:valueStreamRootNode}),valuestreamMilestoneTreePanel=Ext.create("Ext.tree.Panel",{id:"milestonesTreePanel",itemId:"milestonesTreePanel",store:milestoneValueStreamTreeStore,useArrows:!0,rowLines:!0,displayField:"Name",rootVisible:!1,width:this.getWidth(!0),height:this.getHeight(!0),viewConfig:{getRowClass:function(record,index){var nameRecord=Ext.String.format("{0}",record.get("Name"));return nameRecord&&-1===nameRecord.search("valuestream:")?"row-child":"row-parent"}},columns:[{xtype:"treecolumn",text:"Name",dataIndex:"Name",resizeable:!0,flex:3,minWidth:200,renderer:function(value,style,item,rowIndex){var link=Ext.String.format("{0}",value);if(-1===link.search("valuestream:")){var ref=item.get("_ref");link=Ext.String.format("<a target='_top' href='{1}'><b>{0}</b></a>",value,Rally.nav.Manager.getDetailUrl(ref))}else{var onlyName=link.replace("valuestream:","");link=Ext.String.format("<b>{0}</b>",onlyName)}return link}},{text:"Project",dataIndex:"TargetProject",flex:2,hidden:!0},{text:"Start Date",dataIndex:"StartDate",flex:1,renderer:function(value){return value?Rally.util.DateTime.format(value,"m/d/Y"):void 0},hidden:!0},{text:"Target Date",dataIndex:"TargetDate",flex:1,renderer:function(value){if(value){var formattedDate=Rally.util.DateTime.format(value,"M Y"),formattedField;return formattedField=new Date>value?Ext.String.format("<div style='color:grey'>{0}</div>",formattedDate):Ext.String.format("<div>{0}</div>",formattedDate)}}},{xtype:"templatecolumn",text:"Progress",dataIndex:"StoryProgressPercent",tooltip:"click to view details.",tpl:Ext.create("Rally.ui.renderer.template.progressbar.ProgressBarTemplate",{percentDoneName:"StoryProgressPercent",showOnlyIfInProgress:!0,showDangerNotificationFn:function(value){return value.FeaturesWithoutChildrenCount>0?!0:!1},calculateColorFn:function(value){var targetDate=value.TargetDate,per=0,colorHex="#77D38D";return value.StoryProgressPercent&&targetDate&&(per=parseFloat(value.StoryProgressPercent),colorHex=me._getPercentDoneColor(targetDate,value.StartDate,value.StoryProgressPercent)),colorHex}}),flex:1},{text:"Accepted Count",dataIndex:"AcceptedLeafStoryCount",flex:1,hidden:!0},{text:"Story Count",dataIndex:"LeafStoryCount",flex:1,hidden:!0},{text:"Status",dataIndex:"DisplayColor",flex:1,renderer:function(value){if(value){var colorHtml=Ext.String.format("<div class= 'color-box' style= 'background-color: {0};'></div>",value);return colorHtml}}},{text:"Notes",dataIndex:"Notes",flex:4}]});valuestreamMilestoneTreePanel.on({cellclick:{fn:this._onTreePanelItemClick,scope:this}}),this.down("#gridContainer").add(valuestreamMilestoneTreePanel),Ext.getBody().unmask()},_onTreePanelItemClick:function(view,td,cellIndex,record,tr,rowIndex){if(4===cellIndex){console.log("In side the Progress bar cell"),console.log("On Cell Click: Data Model is : ",record);var tooltipTitle="<h3>"+record.data.FormattedID+" : "+record.data.Name+"</h3>",htmlString=this._getTootipPopupContent(record),tooltip=Ext.create("Rally.ui.tooltip.ToolTip",{target:td,anchor:"left",items:[{xtype:"label",forId:"myFieldId",html:tooltipTitle,margin:"10 10 10 10"},{xtype:"form",bodyPadding:10,layout:"fit",items:[{xtype:"displayfield",fieldLabel:"Details",hideLabel:!0,name:"progress_details",value:htmlString,autoScroll:!0}]}],layout:{type:"vbox",align:"left"}});console.log("Tool Tip: ",tooltip)}},_getTootipPopupContent:function(record){var progressPercentage=100*record.data.StoryProgressPercent.toFixed(2),htmlstring="<h3>Progress:</h3>";htmlstring+="<p>Total Story Count: <span><strong>"+record.data.LeafStoryCount+"</strong></span></p>",htmlstring+="<p>Total Accepted Story Count: <span><strong>"+record.data.AcceptedLeafStoryCount+"</strong></span></p>",htmlstring+="<p>Percentage of Progress: <span><strong>"+progressPercentage+" %</strong></span></p>",htmlstring+="<hr>",record.data.FeaturesWithoutChildrenCount>0&&(htmlstring+='<h3 style="color:red;">Alerts:</h3>',htmlstring+='<p style="color:red; font-weight: bold;">There are <span><u>'+record.data.FeaturesWithoutChildrenCount+" Features</u></span> still not broken down into user stories.</p>",htmlstring+="<hr>");var targetDate=null!==record.data.TargetDate?Rally.util.DateTime.format(record.data.TargetDate,"m/d/Y"):"Not Mentioned",actualStartDate=null!==record.data.StartDate?Rally.util.DateTime.format(record.data.StartDate,"m/d/Y"):"Not Started";return htmlstring+="<h3>Info:</h3>",htmlstring+="<p>Milestone Target Date: <span><strong>"+targetDate+"</strong></p>",htmlstring+="<p>Milestone Actual Start Date: <span><strong>"+actualStartDate+"</strong></p>",htmlstring+="<hr>",htmlstring+="<h3>Notes: <h3>",htmlstring+='<p style="width: 100px; white-space: pre-line;">'+record.data.Notes+"</p>"},_onTreePanelItemMouseEnter:function(view,record,item,index){console.log("On Mouse Enter: record is : ",record),console.log("On Mouse Enter: column is : ",item),console.log("On Mouse Enter: index is : ",index)},_getPercentDoneColor:function(milestoneEndDate,milestoneStartDate,milestonePercentDone){var greenHex="#1B801D",yellowHex="#FFFF00",redHex="#FE2E2E",blueHex="#1874CD",whiteHex="#FFFFFF",startDate=null,endDate=null,asOfDate=new Date,percentComplete=100*milestonePercentDone;startDate=null!==milestoneStartDate?milestoneStartDate:asOfDate,endDate=null!==milestoneEndDate?milestoneEndDate:asOfDate;var dateDifference=Rally.util.DateTime.getDifference(endDate,startDate,"day"),startDateNumber=1,endDateNumber=startDateNumber+dateDifference,asOfDateNumber=Rally.util.DateTime.getDifference(asOfDate,startDate,"day")+1,acceptanceStartDelay=.2*(endDateNumber-startDateNumber),warningDelay=.2*(endDateNumber-startDateNumber),inProgress=percentComplete>0;if(startDate>asOfDate)return whiteHex;if(asOfDate>=endDate)return percentComplete>=100?blueHex:redHex;var redXIntercept=startDateNumber+acceptanceStartDelay+warningDelay,redSlope=100/(endDateNumber-redXIntercept),redYIntercept=-1*redXIntercept*redSlope,redThreshold=redSlope*asOfDateNumber+redYIntercept;if(redThreshold>percentComplete)return redHex;var yellowXIntercept=startDateNumber+acceptanceStartDelay,yellowSlope=100/(endDateNumber-yellowXIntercept),yellowYIntercept=-1*yellowXIntercept*yellowSlope,yellowThreshold=yellowSlope*asOfDateNumber+yellowYIntercept;return yellowThreshold>percentComplete?yellowHex:greenHex},_createValueStreamNodesAlongWithAssociatedChildMilestoneNodes:function(valustreamRootNode){var that=this;Ext.Array.each(this.valueStreamMilestoneColl,function(thisData){var valueStreamNode=that._createValueStreamNode(thisData.key);Ext.Array.each(thisData.value,function(thisMilestoneData){var milestoneNode=that._createMilestoneNode(thisMilestoneData);valueStreamNode.appendChild(milestoneNode)}),valustreamRootNode.appendChild(valueStreamNode)})},_createValueStreamNode:function(valuestreamData){var valueStreamLable="valuestream: "+valuestreamData,valustreamTreeNode=Ext.create("MilestoneTreeModel",{Name:valueStreamLable,AcceptedLeafStoryCount:"",LeafStoryCount:"",StoryProgressPercent:"",leaf:!1,expandable:!0,expanded:!0,iconCls:"no-icon"});return valustreamTreeNode},_createMilestoneNode:function(milestoneData){var targetProjectName=null!==milestoneData.get("TargetProject")?milestoneData.get("TargetProject")._refObjectName:"Global",milestoneTreeNode=Ext.create("MilestoneTreeModel",{FormattedID:milestoneData.get("FormattedID"),Name:milestoneData.get("Name"),StartDate:milestoneData.get("StartDate"),TargetDate:milestoneData.get("TargetDate"),TargetProject:targetProjectName,DisplayColor:milestoneData.get("DisplayColor"),Notes:milestoneData.get("Notes"),_ref:milestoneData.get("_ref"),AcceptedLeafStoryCount:""+milestoneData.get("AcceptedLeafStoryCount"),LeafStoryCount:""+milestoneData.get("LeafStoryCount"),StoryProgressPercent:""+milestoneData.get("StoryProgressPercent"),FeaturesWithoutChildrenCount:""+milestoneData.get("FeaturesWithoutChildrenCount"),leaf:!0,expandable:!1,expanded:!1,iconCls:"no-icon"});return milestoneTreeNode},_getAllAssociatedMilestones:function(valuestream,milestoneStoreData){var milestoneColl=[],that=this;return Ext.Array.each(milestoneStoreData,function(milestone){var vsRecord=milestone.get("ValueStream");vsRecord=null!==vsRecord&&""!==vsRecord?vsRecord:"N/A",vsRecord===valuestream&&milestoneColl.push(milestone)}),milestoneColl},_getVisibilityFilter:function(){var visibilityCheckBox=Ext.getCmp("executiveVisibilityCheckbox");return visibilityCheckBox.getValue()}});

            Rally.launchApp('CustomApp', {
                name:"MilestoneStatusApp",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .ico-test-valustream{width:20px;height:20px;top:8px;background-image:url('https://cdn4.iconfinder.com/data/icons/stash/128/ruby-16.png') !important}.ico-test-milestone{width:20px;height:20px;top:8px;background-image:url('https://cdn1.iconfinder.com/data/icons/all_google_icons_symbols_by_carlosjj-du/16/milestone.png') !important}.color-box{width:15px;height:15px;display:inline-block;background-color:#ccc;position:relative;left:10px;top:0px}.no-icon{display:none;background-image:url('ext/resources/images/default/s.gif') !important}.row-parent .x-grid-cell{background-color:#77D38D !important}.x-grid-item-over .row-parent .x-grid-cell{background-color:#3da5f5 !important}.x-grid-item-selected .row-parent .x-grid-cell{background-color:#ff0 !important}.row-child .x-grid-cell{background-color:#FFFFFF !important}.x-grid-item-over .row-child .x-grid-cell{background-color:#C2FABA !important}.x-grid-item-selected .row-child .x-grid-cell{background-color:#80AA79 !important}
    </style>
</head>
<body>
</body>
</html>
